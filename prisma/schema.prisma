generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                  String    @id @default(cuid())
  email               String    @unique
  password            String
  name                String?
  phoneNumber         String?
  role                String    @default("USER") // USER, ADMIN
  credits             Int       @default(10) // Genel krediler
  cvChatTokens        Int       @default(20) // CV AI sohbet jetonları (ayrı)
  cvApplicationsUsed  Int       @default(0) // Kullanılan CV başvuru sayısı
  emailVerified       DateTime?
  verificationCode    String?
  newEmail            String?
  emailChangeCode     String?
  verificationExpires DateTime?

  // Billing Info
  address   String?
  city      String?
  district  String?
  taxNumber String?
  taxOffice String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt
  cvs          CV[]
  cvanalyses   CVAnalysis[]
  chatSessions ChatSession[]
  subscription Subscription?
  usageRecords UsageRecord[]
  adminLogs    AdminLog[] // Admin tarafından yapılan işlemler
  salesRecords SalesRecord[] // Satış kayıtları
  chatRooms    ChatRoom[]
}

// Admin işlem logları - Tüm admin aksiyonlarını takip eder
model AdminLog {
  id         String   @id @default(cuid())
  adminId    String
  action     String // CREATE, UPDATE, DELETE, APPROVE, REJECT, LOGIN, etc.
  targetType String // USER, SUBSCRIPTION, JOB, SYSTEM, etc.
  targetId   String? // İşlem yapılan kaydın ID'si
  details    String? // JSON formatında detaylar
  ipAddress  String? // İşlem yapan IP adresi
  userAgent  String? // Tarayıcı bilgisi
  createdAt  DateTime @default(now())
  admin      User     @relation(fields: [adminId], references: [id], onDelete: Cascade)

  @@index([adminId])
  @@index([action])
  @@index([targetType])
  @@index([createdAt])
}

// Satış kayıtları - Abonelik satışlarını takip eder
model SalesRecord {
  id               String   @id @default(cuid())
  orderNumber      String   @unique // Benzersiz sipariş numarası: KK-XXXXXX
  userId           String
  subscriptionId   String?
  plan             String // BASIC, PREMIUM
  amount           Float // Satış tutarı
  currency         String   @default("TRY")
  paymentMethod    String? // HAVALE, KREDI_KARTI, etc.
  status           String   @default("COMPLETED") // PENDING, COMPLETED, CANCELLED, REFUNDED
  notes            String? // Admin notları
  // Fatura bilgileri (sipariş anındaki kullanıcı bilgileri)
  billingName      String? // Fatura adı soyadı
  billingEmail     String? // Fatura e-postası
  billingPhone     String? // Fatura telefonu
  billingAddress   String? // Fatura adresi
  billingCity      String? // Fatura şehri
  billingDistrict  String? // Fatura ilçesi
  billingTaxNumber String? // Vergi numarası
  billingTaxOffice String? // Vergi dairesi
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

model Subscription {
  id        String    @id @default(cuid())
  userId    String    @unique
  plan      String    @default("FREE")
  status    String    @default("PENDING")
  orderCode String?   @unique
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model CV {
  id             String       @id @default(cuid())
  userId         String
  title          String
  data           String
  template       String       @default("modern")
  pdfPath        String? // PDF dosya yolu
  pdfGeneratedAt DateTime? // PDF oluşturma tarihi
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  analyses       CVAnalysis[]
}

// Site ayarları - admin tarafından düzenlenebilir
model SiteSettings {
  id        String   @id @default(cuid())
  key       String   @unique // örn: subscription_plans, site_info
  value     String // JSON formatında değer
  updatedBy String? // Son güncelleyen admin ID
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model UsageRecord {
  id        String   @id @default(cuid())
  userId    String
  type      String
  count     Int      @default(1)
  month     Int
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, type, month])
}

model ChatSession {
  id        String   @id @default(cuid())
  userId    String
  messages  String
  cvId      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model JobListing {
  id             String       @id @default(cuid())
  title          String
  company        String
  location       String?
  description    String
  requirements   String?
  type           String       @default("PRIVATE")
  sourceUrl      String?
  applicationUrl String? // Başvuru linki
  salary         String? // Maaş bilgisi
  deadline       DateTime? // Son başvuru tarihi
  employerPhone  String? // İşveren telefonu (opsiyonel)
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  analyses       CVAnalysis[]
}

model CVAnalysis {
  id        String     @id @default(cuid())
  userId    String
  cvId      String
  jobId     String
  score     Int
  feedback  String
  createdAt DateTime   @default(now())
  job       JobListing @relation(fields: [jobId], references: [id], onDelete: Cascade)
  cv        CV         @relation(fields: [cvId], references: [id], onDelete: Cascade)
  user      User       @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Kampanya kuponları - İndirim kodları yönetimi
model Coupon {
  id              String    @id @default(cuid())
  code            String    @unique // Kupon kodu (örn: YILBASI2026)
  name            String? // Kupon adı (örn: Yılbaşı Kampanyası)
  discountType    String    @default("PERCENT") // PERCENT veya FIXED
  discountValue   Float // % oran veya sabit tutar (örn: 50 = %50)
  validFrom       DateTime  @default(now())
  validUntil      DateTime?
  maxUsage        Int? // Maksimum kullanım sayısı (null = sınırsız)
  usageCount      Int       @default(0) // Mevcut kullanım sayısı
  planRestriction String? // Belirli plan için mi (BASIC, PREMIUM veya null = tümü)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([code])
  @@index([isActive])
}

// Kariyer Danışmanları - Premium aboneler için
model Consultant {
  id          String             @id @default(cuid())
  name        String
  phone       String
  title       String
  description String?
  avatarUrl   String?
  isActive    Boolean            @default(true)
  userId      String?            @unique // MODERATOR user bağlantısı
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt
  chatRooms   ChatRoom[]
  ratings     ConsultantRating[]
}

// Danışman Sohbet Odaları
model ChatRoom {
  id           String            @id @default(cuid())
  userId       String
  consultantId String
  status       String            @default("ACTIVE") // ACTIVE, CLOSED
  closedAt     DateTime?
  closedBy     String? // Kapatan kişinin ID'si
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  user         User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  consultant   Consultant        @relation(fields: [consultantId], references: [id], onDelete: Cascade)
  messages     ChatMessage[]
  rating       ConsultantRating?

  @@unique([userId, consultantId])
  @@index([userId])
  @@index([consultantId])
  @@index([status])
}

// Sohbet Mesajları
model ChatMessage {
  id         String   @id @default(cuid())
  roomId     String
  senderId   String // User veya Consultant ID
  senderType String // "USER" veya "CONSULTANT"
  content    String
  isRead     Boolean  @default(false)
  createdAt  DateTime @default(now())
  room       ChatRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)

  @@index([roomId])
  @@index([createdAt])
}

// Danışman Puanlama
model ConsultantRating {
  id           String     @id @default(cuid())
  roomId       String     @unique
  consultantId String
  userId       String
  rating       Int // 1-5 yıldız
  comment      String?
  createdAt    DateTime   @default(now())
  room         ChatRoom   @relation(fields: [roomId], references: [id], onDelete: Cascade)
  consultant   Consultant @relation(fields: [consultantId], references: [id], onDelete: Cascade)

  @@index([consultantId])
  @@index([userId])
}

// Medya Kategorileri - Admin görsel yönetimi
model MediaCategory {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  media     Media[]
}

// Medya Dosyaları - Yüklenen görseller
model Media {
  id         String         @id @default(cuid())
  filename   String
  url        String
  mimeType   String?
  size       Int?
  categoryId String?
  createdAt  DateTime       @default(now())
  category   MediaCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)

  @@index([categoryId])
  @@index([createdAt])
}

// WhatsApp mesaj logları - Gönderilen tüm mesajları takip eder
model WhatsAppLog {
  id           String   @id @default(cuid())
  phoneNumber  String // Gönderilen telefon numarası
  message      String // Gönderilen mesaj içeriği
  messageType  String   @default("VERIFICATION") // VERIFICATION, PAYMENT, NOTIFICATION
  status       String   @default("SENT") // SENT, FAILED, PENDING
  userId       String? // İlişkilendirilmiş kullanıcı ID'si (varsa)
  userEmail    String? // Kullanıcı e-postası (log için)
  errorMessage String? // Hata mesajı (başarısızsa)
  createdAt    DateTime @default(now())

  @@index([phoneNumber])
  @@index([messageType])
  @@index([status])
  @@index([createdAt])
}

// Çerez onayı kayıtları - IP adresleri ile
model CookieConsent {
  id          String   @id @default(cuid())
  ipAddress   String
  userAgent   String?
  userId      String? // Oturum açmış kullanıcı varsa
  consentType String   @default("all") // all, necessary, analytics
  acceptedAt  DateTime @default(now())
  expiresAt   DateTime // 30 gün sonra

  @@index([ipAddress])
  @@index([userId])
  @@index([acceptedAt])
}
